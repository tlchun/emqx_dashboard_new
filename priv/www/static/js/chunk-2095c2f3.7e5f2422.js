(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2095c2f3"],{"12b7":function(e,t,s){},2870:function(e,t,s){},"2b0b":function(e,t,s){"use strict";var n=s("12b7"),a=s.n(n);a.a},a495:function(e,t,s){"use strict";var n=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"stretch-height",attrs:{id:"stretch-height"},on:{mousedown:e.handleMousedown}},[s("i",{staticClass:"el-icon-more"})])},a=[],i=(s("c5f6"),{name:"StretchHeight",model:{prop:"value",event:"change"},props:{value:{required:!0,type:Number}},data:function(){return{}},created:function(){document.onmouseup=function(){document.onmousemove=null}},methods:{handleMousedown:function(e){var t=this,s=e.y;document.onmousemove=function(e){var n=e.y,a=n-s;s=e.y,t.$emit("change",t.value+a)}}}}),r=i,c=(s("2b0b"),s("2877")),l=Object(c["a"])(r,n,a,!1,null,null,null);t["a"]=l.exports},b395:function(e,t,s){"use strict";var n=s("2870"),a=s.n(n);a.a},e94e:function(e,t,s){"use strict";s.r(t);var n=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"rule-create"},[s("page-header",[s("div",{staticClass:"page-header-title-view"},[s("div",{staticClass:"title"},[e._v(e._s(e.$t("RuleEngine.createRules")))])]),s("div",{staticClass:"page-header-content-view"},[s("div",{staticClass:"content"},[s("p",{staticClass:"description"},[e._v("\n          "+e._s(e.$t("RuleEngine.definingRuleConditionsAndDataProcessing"))+"\n        ")])])])]),s("div",{staticClass:"emq-list-body rule-wrapper app-wrapper"},[s("a-card",{staticClass:"emq-list-card"},[s("el-row",{attrs:{gutter:20}},[s("el-col",{attrs:{span:15}},[s("el-form",{ref:"record",attrs:{model:e.record,rules:e.rules,"label-width":"120px","label-position":"left",size:"small","label-suffix":":"}},[s("el-form-item",{staticClass:"code-editor__item",attrs:{prop:"rawsql",label:e.$t("RuleEngine.sqlInput")}},[s("div",{staticClass:"monaco-container monaco-sql",style:{height:e.sqlEditorHeight+"px"}},[s("monaco",{staticClass:"sql",attrs:{id:"rule-sql",warp:"",lang:"sql",provider:e.sqlProvider},on:{"qucik-save":e.handleSQLTest},model:{value:e.record.rawsql,callback:function(t){e.$set(e.record,"rawsql",t)},expression:"record.rawsql"}})],1),s("stretch-height",{model:{value:e.sqlEditorHeight,callback:function(t){e.sqlEditorHeight=t},expression:"sqlEditorHeight"}})],1),s("el-form-item",{attrs:{prop:"id",label:e.$t("RuleEngine.ruleID")}},[s("el-input",{attrs:{disabled:e.isEdit},model:{value:e.record.id,callback:function(t){e.$set(e.record,"id",t)},expression:"record.id"}})],1),s("el-form-item",{attrs:{prop:"description",label:e.$t("RuleEngine.resourceDes")}},[s("el-input",{model:{value:e.record.description,callback:function(t){e.$set(e.record,"description",t)},expression:"record.description"}})],1),s("el-form-item",{attrs:{label:e.$t("RuleEngine.sqlTest")}},[s("el-switch",{on:{change:e.initTestFormItem},model:{value:e.showTest,callback:function(t){e.showTest=t},expression:"showTest"}}),s("el-popover",{attrs:{width:"220",placement:"right",trigger:"hover"}},[e._v("\n                "+e._s(e.$t("RuleEngine.inputMetadata"))+"\n                "),s("i",{staticClass:"icon el-icon-question",attrs:{slot:"reference"},slot:"reference"})])],1),s("el-collapse-transition",[e.showTest?s("div",[e._l(Object.keys(e.selectEvent.test_columns),function(t){return s("el-form-item",e._b({key:t,class:{"code-sql":"payload"===t,payload:"payload"===t}},"el-form-item",{label:t,prop:"ctx."+t},!1),["payload"!==t?s("el-input",{model:{value:e.record.ctx[t],callback:function(s){e.$set(e.record.ctx,t,s)},expression:"record.ctx[k]"}}):[s("div",{staticClass:"monaco-container monaco-payload",style:{height:e.payloadEditorHeight+"px"}},[s("monaco",{staticClass:"payload",attrs:{id:"payload",lang:e.payloadType},on:{"qucik-save":e.handleSQLTest},model:{value:e.record.ctx.payload,callback:function(t){e.$set(e.record.ctx,"payload",t)},expression:"record.ctx.payload"}})],1),s("div",{staticClass:"payload-type"},[s("el-radio-group",{model:{value:e.payloadType,callback:function(t){e.payloadType=t},expression:"payloadType"}},[s("el-radio",{attrs:{label:"json"}},[e._v("JSON")]),s("el-radio",{attrs:{label:"plaintext"}},[e._v("Plaintext")])],1)],1),s("stretch-height",{staticClass:"payload",model:{value:e.payloadEditorHeight,callback:function(t){e.payloadEditorHeight=t},expression:"payloadEditorHeight"}})]],2)}),s("el-form-item",[s("span",{attrs:{slot:"label"},slot:"label"},[e._v("Â ")]),s("el-button",{attrs:{type:"primary"},on:{click:e.handleSQLTest}},[e._v("\n                    "+e._s(e.$t("RuleEngine.sqlTest"))+"\n                  ")])],1),s("el-form-item",{staticClass:"code-editor__item",attrs:{label:e.$t("RuleEngine.testOutput")}},[s("div",{staticClass:"monaco-container monaco-test-output",staticStyle:{height:"200px"}},[s("monaco",{staticClass:"test-output",attrs:{id:"testOutput",lang:"json",disabled:!0},model:{value:e.testOutPut,callback:function(t){e.testOutPut=t},expression:"testOutPut"}})],1)])],2):e._e()])],1)],1),s("el-col",{staticClass:"tips-form",attrs:{span:9}},[s("div",{staticClass:"tips-item"},[s("div",{staticStyle:{color:"#606266"}},[e._v("\n              "+e._s(e.$t("RuleEngine.currentEventAvailableField"))+"\n              "),s("transition",{attrs:{name:"el-fade-in-linear"}},[e.clipboardStatus?s("span",{staticClass:"copy-success"},[e._v(e._s(e.clipboardStatus))]):e._e()])],1),s("div",{staticClass:"tips-wrapper code"},e._l(e.availableFields,function(t){return s("span",{directives:[{name:"clipboard",rawName:"v-clipboard:cpoy",value:t,expression:"key",arg:"cpoy"},{name:"clipboard",rawName:"v-clipboard:success",value:e.copyAvailableFieldsSuccess,expression:"copyAvailableFieldsSuccess",arg:"success"}],key:t,staticClass:"available-fields"},[e._v("\n                "+e._s(t)+"\n              ")])}),0)]),s("div",{staticClass:"tips-item"},[s("div",{staticStyle:{color:"#606266"}},[e._v(e._s(e.$t("RuleEngine.exampleSql")))]),s("div",{staticClass:"tips-wrapper code"},[s("code",[e._v(e._s(e.selectEvent.sql_example))])])])])],1)],1),s("a-card",{staticClass:"emq-list-card"},[s("div",{staticClass:"emq-title"},[s("div",{staticClass:"title required-title"},[e._v("\n          "+e._s(e.$t("RuleEngine.responseAction"))+"\n        ")]),s("span",{staticClass:"sub-title"},[e._v("\n          "+e._s(e.$t("RuleEngine.processingMessagesForHitRules"))+"\n        ")])]),s("div",{staticClass:"rule-action-wrapper"},[s("rule-actions",{ref:"ruleAction",model:{value:e.record.actions,callback:function(t){e.$set(e.record,"actions",t)},expression:"record.actions"}})],1)]),s("div",{staticClass:"button-group__center"},[s("el-button",{attrs:{type:"default",size:"medium"},on:{click:function(t){return e.$router.push({path:"/rules"})}}},[e._v("\n        "+e._s(e.$t("Base.cancel"))+"\n      ")]),s("el-button",{attrs:{type:"primary",size:"medium"},on:{click:e.save}},[e._v("\n        "+e._s(e.isEdit?e.$t("Base.confirm"):e.$t("Base.create"))+"\n      ")])],1)],1)],1)},a=[],i=s("7618"),r=(s("4917"),s("3b2b"),s("28a5"),s("768b")),c=(s("7514"),s("96cf"),s("3b8d")),l=(s("ac6a"),s("456d"),s("6b54"),s("bd43")),o=s("1f75");function u(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{_limit:500,_page:1};return o["a"].get("/routes",e)}var d=s("90b9"),p=s("9146"),m=s("a495"),h=s("ad43"),v=s("12cb"),g=s("a47b"),f=g["a"].state.lang,b=v["default"][f],y=[{name:"clientid",documentation:b.RuleEngine.clientid_doc,type:"Field",default:"c_emqx",valueType:"string"},{name:"username",documentation:b.RuleEngine.username_doc,type:"Field",default:"u_emqx",valueType:"string"},{name:"event",documentation:b.RuleEngine.event_doc,type:"Field",default:"disconnect",valueType:"string"},{name:"id",documentation:b.RuleEngine.id_doc,type:"Field",default:"--",valueType:"string"},{name:"payload",documentation:b.RuleEngine.payload_doc,type:"Field",default:'{"msg": "hello"}',valueType:"string"},{name:"peername",documentation:b.RuleEngine.peername_doc,type:"Field",default:"127.0.0.1:63412",valueType:"string"},{name:"qos",documentation:b.RuleEngine.qos_doc,type:"Field",default:1,valueType:"integer"},{name:"timestamp",documentation:b.RuleEngine.timestamp_doc,type:"Field",default:1576549961086,valueType:"integer"},{name:"topic",documentation:b.RuleEngine.topic_doc,type:"Field",default:"t/a",valueType:"string"},{name:"node",documentation:b.RuleEngine.node_doc,type:"Field",default:"emqx@127.0.0.1",valueType:"string"},{name:'"$events/message_delivered"',documentation:b.RuleEngine.message_delivered,type:"Method"},{name:'"$events/message_acked"',documentation:b.RuleEngine.message_acked,type:"Method"},{name:'"$events/message_dropped"',documentation:b.RuleEngine.message_dropped,type:"Method"},{name:'"$events/client_connected"',documentation:b.RuleEngine.client_connected,type:"Method"},{name:'"$events/client_disconnected"',documentation:b.RuleEngine.client_disconnected,type:"Method"},{name:'"$events/session_subscribed"',documentation:b.RuleEngine.session_subscribed,type:"Method"},{name:'"$events/session_unsubscribed"',documentation:b.RuleEngine.session_unsubscribed,type:"Method"}],_={name:"RuleCrate",components:{RuleActions:h["a"],Monaco:p["a"],StretchHeight:m["a"]},props:{},data:function(){return{loadRuleEvents:l["l"],isEdit:!1,needCheckSql:!0,sqlEditorHeight:320,payloadEditorHeight:200,templateEditorHeight:100,payloadType:"json",topics:[],events:[],testOutPut:"",selectEvent:{columns:["clientid","username","event","id","payload","peername","qos","timestamp","topic","node"],description:"$events/message_publish",event:"$events/message_publish",sql_example:'SELECT * FROM "t/#"',test_columns:{clientid:"c_emqx",username:"u_emqx",topic:"t/a",qos:1,payload:'{"msg": "hello"}'},title:"$events/message_publish"},timer:0,showTest:!1,clipboardContent:"",clipboardStatus:"",record:{rawsql:"SELECT * FROM",actions:[],description:"",ctx:{},id:"rule:".concat(Math.random().toString().slice(3,9))},rules:{rawsql:{required:!0,message:this.$t("RuleEngine.pleaseEnterTheSQL")},id:{required:!0,validator:d["q"]}},templateStr:"",templateOutput:"",sqlTestSuccess:!1}},computed:{availableFields:function(){return this.selectEvent.columns},testField:function(){return Object.keys(this.selectEvent.test_columns)},sqlProvider:function(){return y},currentRule:function(){return this.$route.query.rule}},watch:{"record.rawsql":"handleSqlChanged"},created:function(){var e=Object(c["a"])(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,Object(l["l"])();case 2:return this.events=e.sent,this.selectEvent=this.events[0],e.next=6,u();case 6:t=e.sent,this.topics=t.items||[],this.currentRule?(this.isEdit=!0,this.loadRule()):this.initData("$events/message_publish");case 9:case"end":return e.stop()}},e,this)}));function t(){return e.apply(this,arguments)}return t}(),methods:{initData:function(e){this.selectEvent=this.events.find(function(t){return t.event===e});var t=this.selectEvent.sql_example;this.record.rawsql=Object(d["o"])(t),this.initTestFormItem();var s=this.$refs.ruleAction;s&&s.initData()},handleSqlChanged:function(e){if(this.triggerEventChange(e),this.needCheckSql){var t=Object(d["n"])(e);t&&this.sqlParse(e,t[0])}},sqlParse:function(e,t){var s=this;this.$confirm(this.$t("RuleEngine.parse_confirm"),this.$t("Base.warning"),{confirmButtonText:this.$t("Base.confirm"),cancelButtonText:this.$t("Base.cancel"),type:"warning"}).then(function(){s.record.rawsql=Object(d["o"])(Object(d["m"])(e,t))}).catch(function(){s.needCheckSql=!1})},triggerEventChange:function(e){var t=["events/message_delivered","events/message_acked","events/message_dropped","events/client_connected","events/client_disconnected","events/session_subscribed","events/session_unsubscribed"],s=null,n="";t.forEach(function(t){var n=t.split("/"),a=Object(r["a"])(n,2),i=a[0],c=a[1],l=new RegExp("\\$".concat(i,"\\/").concat(c),"gim");e.match(l)&&(s=e.match(l))}),n=s?s[0]:"$events/message_publish",n!==this.selectEvent.event&&(this.selectEvent=this.events.find(function(e){return e.event===n})||{columns:{},test_columns:{}},this.sqlPrimaryKey=this.events.columns,this.initTestFormItem())},initTestFormItem:function(){this.testOutPut="";var e={},t=this.selectEvent.test_columns;Object.keys(t).forEach(function(s){var n=t[s];"object"===Object(i["a"])(n)&&(n=JSON.stringify(n,null,2)),e[s]=n}),this.$set(this.record,"ctx",e)},beforeSqlValid:function(e){var t=Object(d["n"])(e);return!t||(this.sqlParse(e,t[0]),!1)},handleSQLTest:function(){var e=this;this.needCheckSql=!0,this.$refs.record.validate(function(){var t=Object(c["a"])(regeneratorRuntime.mark(function t(s){var n;return regeneratorRuntime.wrap(function(t){while(1)switch(t.prev=t.next){case 0:if(s){t.next=6;break}if(!e.showTest||e.record.id){t.next=5;break}e.$refs.record.clearValidate("id"),t.next=6;break;case 5:return t.abrupt("return");case 6:if(e.beforeSqlValid(e.record.rawsql)){t.next=8;break}return t.abrupt("return");case 8:if(n=JSON.parse(JSON.stringify(e.record)),e.testOutPut="",n.ctx.payload)try{n.ctx.payload=JSON.stringify(JSON.parse(n.ctx.payload))}catch(a){console.log(a)}Object(l["a"])(n).then(function(t){e.testOutPut=JSON.stringify(t,null,2),e.sqlTestSuccess=!0}).catch(function(t){e.sqlTestSuccess=!1,e.testOutPut="SQL Not Match"===t?e.$t("RuleEngine.resultIsEmpty"):"".concat(e.$t("RuleEngine.checkForErrors"),":\n\n").concat(t)});case 12:case"end":return t.stop()}},t)}));return function(e){return t.apply(this,arguments)}}())},copyAvailableFieldsSuccess:function(){var e=this;this.clipboardStatus=this.$t("Base.copied"),setTimeout(function(){e.clipboardStatus=""},2e3)},save:function(){var e=Object(c["a"])(regeneratorRuntime.mark(function e(){var t,s,n=this;return regeneratorRuntime.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.$refs.record.validate();case 2:if(t=e.sent,t){e.next=5;break}return e.abrupt("return");case 5:if(0!==this.record.actions.length){e.next=8;break}return this.$message.error(this.$t("RuleEngine.pleaseAddAResponseAction")),e.abrupt("return");case 8:s={rawsql:this.record.rawsql,actions:this.record.actions,description:this.record.description},this.isEdit&&this.currentRule?Object(l["o"])(this.currentRule,s).then(function(){n.$message.success(n.$t("RuleEngine.editSuccess")),setTimeout(function(){n.$router.push({path:"/rules"})},600)}):Object(l["c"])(s).then(function(){n.$message.success(n.$t("RuleEngine.createSuccess")),setTimeout(function(){n.$router.push({path:"/rules"})},600)});case 10:case"end":return e.stop()}},e,this)}));function t(){return e.apply(this,arguments)}return t}(),loadRule:function(){var e=Object(c["a"])(regeneratorRuntime.mark(function e(){var t,s=this;return regeneratorRuntime.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,Object(l["k"])(this.currentRule);case 2:t=e.sent,this.record=t,setTimeout(function(){s.$refs.ruleAction.loadActions()},500);case 5:case"end":return e.stop()}},e,this)}));function t(){return e.apply(this,arguments)}return t}(),fillTemplate:function(){this.sqlTestSuccess||this.$message.warning(this.$t("RuleEngine.sqlTestFirst"))}}},E=_,q=(s("b395"),s("2877")),$=Object(q["a"])(E,n,a,!1,null,null,null);t["default"]=$.exports}}]);